<script>
	// Constants and Data
	const storeData = getStoreData();

const storeImages = getStoreImages();

function loadAdminDashboardPage() {
	console.log('Loading Admin Dashboard...');

	// Create loading popup
	const loadingPopup = Swal.fire({
		title: 'Preparing Dashboard',
		html: `
            <div>Loading dashboard components...</div>
            <small>
                • Initializing page layout<br>
                • Preparing store cards<br>
                • Setting up metrics
            </small>
        `,
		didOpen: () => {
			Swal.showLoading();
		},
		allowOutsideClick: false,
		showConfirmButton: false
	});

	if (dashboardPageCache) {
		// Use cached page
		document.getElementById('content-page').innerHTML = dashboardPageCache;
		updatePageIndicator('admin-dashboard');
		initializeStoreSelection();

		// Initialize navMetrics with default values or cached values
		const navMetrics = [{
				id: 'navNew',
				value: dashboardDataCache?.dashboardSummary?.weeklyDRCount || 0
			},
			{
				id: 'navMonthly',
				value: dashboardDataCache?.dashboardSummary?.drCount || 0
			},
			{
				id: 'navLate',
				value: dashboardDataCache?.dashboardSummary?.lateCount || 0
			},
			{
				id: 'navPending',
				value: dashboardDataCache?.dashboardSummary?.pendingCount || 0
			}
		];

		// Update nav metrics elements
		navMetrics.forEach(({
			id,
			value
		}) => {
			const element = document.getElementById(id);
			if (element) {
				element.textContent = value;
			}
		});

		renderCards();

		if (dashboardDataCache) {
			updateDashboard();
		}
	} else {
		loadPage('admin-dashboard', function() {
			dashboardPageCache = document.getElementById('content-page').innerHTML;
			lastDashboardFetchedTime = new Date();
			initializeStoreSelection();

			renderCards(); // Render all cards initially
		});
	}
}

function initializeStoreSelection() {
	console.log('Initializing store selection and event listeners...');
	initializeDropdownMenu();
	initializeFilterButton();
}

// UI Functions
function createCard(storeName, storeInfo) {
	const safeStoreName = storeName.replace(/\s+/g, '');

	// Define metrics with their icons, tooltips, and labels
	const metrics = [{
			id: 'pending',
			icon: '🕒',
			tooltip: 'Pending',
			label: 'Pending'
		},
		{
			id: 'received',
			icon: '✅',
			tooltip: 'Received',
			label: 'Received'
		},
		{
			id: 'notReceived',
			icon: '❌',
			tooltip: 'Not Received',
			label: 'Not Recv'
		},
		{
			id: 'late',
			icon: '⏰',
			tooltip: 'Late',
			label: 'Late'
		},
		{
			id: 'dr',
			icon: '📋',
			tooltip: 'Total DR',
			label: 'DR Total'
		}
	];

	const metricDivs = metrics.map(metric => `
        <div class="metric-container" title="${metric.tooltip}">
            <div class="small-card">
                <div class="metric-content">
                    <span class="metric-icon">${metric.icon}</span>
                    <span id="${metric.id}Count-${storeInfo.id}" class="metric-value">0</span>
                </div>
            </div>
        </div>
    `).join('');

	return `
        <div class="card" id="card-${storeInfo.id}">
            <div class="card-header">
                <div class="card-header-content">
                    <img alt="${storeName}" src="${storeImages[storeName]}" class="store-logo"/>
                    <h3>${storeName}</h3>
                    <p id="store-${safeStoreName}">${storeInfo.name}</p>
                </div>
                <div class="card-actions">
                    <div class="more" onclick="toggleDropdown(this)">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <ul class="admin-dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="#" onclick="viewDetails('${storeInfo.id}', '${storeInfo.name}'); return false;">
                                <i class="fas fa-calendar"></i> View Details
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="small-cards">
                ${metricDivs}
            </div>
        </div>
    `;
}

// Function to toggle dropdown menu
function toggleDropdown(element) {
	const dropdownMenu = element.nextElementSibling;
	const isOpen = dropdownMenu.style.display === 'block';

	// Close all other open dropdowns
	document.querySelectorAll('.admin-dropdown-menu').forEach(menu => {
		menu.style.display = 'none';
	});

	// Toggle current dropdown
	dropdownMenu.style.display = isOpen ? 'none' : 'block';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
	const dropdowns = document.querySelectorAll('.admin-dropdown-menu');
	dropdowns.forEach(dropdown => {
		if (!dropdown.parentElement.contains(event.target)) {
			dropdown.style.display = 'none';
		}
	});
});

// Modify the viewDetails function
function viewDetails(storeIdParam, storeNameParam) {
	console.log('View details for store:', storeIdParam);
	console.log('Store Name:', storeNameParam);

	// Set global variables for store-specific view
	storeName = storeIdParam; // Set storeName globally
	isStoreSpecificView = true;

	// Store the current admin dashboard state before navigating
	adminDashboardPageCache = dashboardPageCache;
	adminDashboardDataCache = dashboardDataCache;

	// Reset dashboard caches to ensure fresh data
	dashboardPageCache = null;
	dashboardDataCache = null;

	// Navigate to user dashboard with store-specific view
	loadUserDashboardPage();
}

function renderCards() {
	const cardsContainer = document.getElementById('cards-container');
	cardsContainer.innerHTML = '';

	Object.entries(storeData).forEach(([storeName, stores]) => {
		stores.forEach(storeInfo => {
			cardsContainer.innerHTML += createCard(storeName, storeInfo);
		});
	});

	// Return the promise from fetchAdminDashboardData
	return fetchAdminDashboardData('All');
}

function fetchAdminDashboardData(selectedStore = 'All') {
	console.log('Fetching admin dashboard data for store:', selectedStore);

	// Comprehensive data retrieval process
	function retrieveAllData() {
		return new Promise((resolve, reject) => {
			google.script.run
				.withSuccessHandler(function(data) {
					try {
						const parsedData = JSON.parse(data);
						if (parsedData.error) throw new Error(parsedData.error);

						resolve(parsedData);
					} catch (error) {
						reject(error);
					}
				})
				.withFailureHandler(reject)
				.getAdminDashboardData(selectedStore);
		});
	}

	// Fetch and process all dashboard data
	return retrieveAllData()
		.then(parsedData => {
			// Update dashboard data cache
			dashboardDataCache = parsedData;

			// Update store metrics
			updateStoreMetrics();

			// Return a promise for overall metrics update
			return new Promise((resolve, reject) => {
				try {
					// Update overall metrics
					updateOverallMetrics();
					resolve(); // Resolve the promise when the update is successful
				} catch (error) {
					reject(error); // Reject the promise if there's an error
				}
			});
		})
		.then(() => {
			// Close loading popup only after overall metrics update is successful
			Swal.close();

			// Show success toast message
			showToast('success', 'Admin dashboard loaded successfully!');
		})
		.catch(error => {
			console.error('Dashboard data retrieval failed:', error);

			// Show error popup
			Swal.fire({
				icon: 'error',
				title: 'Data Retrieval Failed',
				text: 'Unable to load dashboard data. Please try again.',
				footer: `<small>Error: ${error.message || 'Unknown error'}</small>`,
				confirmButtonText: 'Retry',
				showCancelButton: true,
				cancelButtonText: 'Close'
			}).then((result) => {
				if (result.isConfirmed) {
					// Retry fetching dashboard data
					fetchAdminDashboardData(selectedStore);
				}
			});

			// Ensure loading popup is closed in case of error
			Swal.close();
		});
}

// Modify handleFetchError to provide more robust error handling
function handleFetchError(error) {
	console.error('Dashboard data fetch error:', error);

	// Ensure any existing popups are closed
	Swal.close();

	// Show error popup
	Swal.fire({
		icon: 'error',
		title: 'Data Retrieval Failed',
		text: 'Unable to load dashboard data. Please try again.',
		footer: `<small>Error: ${error.message || 'Unknown error'}</small>`,
		confirmButtonText: 'Retry',
		showCancelButton: true,
		cancelButtonText: 'Close'
	}).then((result) => {
		if (result.isConfirmed) {
			// Retry fetching dashboard data
			fetchAdminDashboardData();
		}
	});
}

// Handle successful data retrieval
function handleDashboardData(response) {
	try {
		const data = JSON.parse(response);
		if (data.error) throw new Error(data.error);

		dashboardDataCache = data;
		updateDashboard(); // Update dashboard with the newly fetched data
	} catch (error) {
		console.error('Error processing dashboard data:', error);
		handleFetchError('Error processing dashboard data');
	}
}

function updateDashboard() {
	try {
		console.log('Updating dashboard...');
		updateStoreMetrics();
		updateOverallMetrics();
		console.log('Dashboard update complete.');
	} catch (error) {
		console.error('Error updating dashboard:', error);
	}
}

function updateOverallMetrics() {
	console.log('Updating overall dashboard metrics...');

	// Ensure summary data exists
	const summary = dashboardDataCache?.dashboardSummary;
	if (!summary) {
		console.warn('No summary data available for metrics update');
		throw new Error('No summary data available');
	}

	const currentMonthKey = getMonthYearKey(new Date());

	// Define metrics with fallback to 0
	const metrics = {
		'totalDRCount': summary.drCount || 0,
		'totalPending': summary.pendingCount || 0,
		'totalReceived': summary.receivedCount || 0,
		'totalNotReceived': summary.notReceivedCount || 0,
		'totalLate': (summary.lateCount?.[currentMonthKey] || 0)
	};

	// Update each metric element
	Object.entries(metrics).forEach(([id, value]) => {
		const element = document.getElementById(id);
		if (element) {
			element.textContent = value.toLocaleString(); // Add thousand separators
		}
	});

	console.log('Overall metrics update completed successfully.');
}

function updateStoreMetrics() {
	console.log('Comprehensive store metrics update started...');

	// Ensure dashboardDataCache exists
	if (!dashboardDataCache || !dashboardDataCache.storeData) {
		console.warn('No dashboard data available for metrics update');
		return;
	}

	// Track metrics update process
	const metricsUpdateStart = performance.now();

	// Process metrics for each store
	Object.entries(dashboardDataCache.storeData).forEach(([storeId, storeData]) => {
		try {
			// Log raw data and monthly filtered data
			console.log(`Processing metrics for store ID: ${storeId}`);
			console.log('Raw store data:', storeData);

			// Process store-specific metrics
			const metrics = processStoreData(storeData);

			// Update card metrics for the specific store
			updateCardMetrics(storeId, metrics);
		} catch (error) {
			console.error(`Error processing metrics for store ${storeId}:`, error);
		}
	});

	const metricsUpdateEnd = performance.now();
	console.log(`Store metrics update completed in ${(metricsUpdateEnd - metricsUpdateStart).toFixed(2)}ms`);
}

function updateCardMetrics(storeId, metrics) {
	const metricIds = ['pending', 'received', 'notReceived', 'late', 'dr'];
	metricIds.forEach(metric => {
		const element = document.getElementById(`${metric}Count-${storeId}`);
		if (element) {
			element.textContent = metrics[metric] || 0;
		}
	});
}

function storeSelection() {
	console.log('Initializing store selection and event listeners...');
	initializeDropdownMenu();
	initializeFilterButton();
	renderCards(); // Render cards for 'All' stores initially
}
</script>
