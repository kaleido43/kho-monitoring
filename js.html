<script>
$(document).ready(function() {
    // Use the functions from js-utilities.html
    resetGlobalVariables();
    initializeGlobalVariables();
    
    // Show loading screen
    showLoadingScreen('Please Wait...', 'We are organizing the latest information for you.');
    
    // Initialize sidebar
    initializeSidebar();

    // Hide transmittal menu for administrators
    if (userType === 'Administrator') {
        $('.transmittal-menu-item').hide();
    }

    // Load dashboard
    loadDashboardPage();

    // Set indicator elements
    setIndicatorElements(name, userType, userAddress, storeName);

    // Check for missing elements
    checkMissingElements(['indicator-name', 'indicator-address', 'indicator-store', 'lockName', 'lockType']);
});

// Initialize the sidebar (keep this function in js.html)
function initializeSidebar() {
    $('.sidebar-dropdown-menu').slideUp('fast');

    // Handle dropdown menu clicks
    $(document).on('click', '.sidebar-menu-item.has-dropdown > a', function(e) {
        e.preventDefault();
        const $parent = $(this).parent();

        // Close other dropdowns if not focused
        if (!$parent.hasClass('focused')) {
            $parent.parent().find('.sidebar-dropdown-menu').slideUp('fast');
            $parent.parent().find('.has-dropdown').removeClass('focused');
        }

        // Toggle the clicked dropdown
        $(this).next().slideToggle('fast');
        $parent.toggleClass('focused');
    });

    // Toggle sidebar collapse
    $('.sidebar-toggle').click(function() {
        $('.sidebar').toggleClass('collapsed');
        $('.sidebar-dropdown-menu').slideUp('fast');
        $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
    });

    // Handle overlay clicks to collapse sidebar
    $('.sidebar-overlay').click(function() {
        $('.sidebar').addClass('collapsed');
        $('.sidebar-dropdown-menu').slideUp('fast');
        $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
    });

    // Automatically collapse sidebar on small screens
    if (window.innerWidth < 768) {
        $('.sidebar').addClass('collapsed');
    }

    // Handle window resize to toggle sidebar
    $(window).resize(function() {
        if (window.innerWidth >= 768) {
            $('.sidebar').removeClass('collapsed');
        }
    });
}

// Page Loading Function
function loadPage(page, callback) {
    if (page === 'transmittal') {
        if (transmittalDataCache) {
            console.log('Using cached transmittal data.');
            document.getElementById('content-page').innerHTML = transmittalPageCache;
            updatePageIndicator('transmittal');
            transmittalElements(); // Initialize transmittal page elements

            // Add event listener for transmittal data loaded
            const transmittalLoadHandler = (event) => {
                document.removeEventListener('transmittalDataLoaded', transmittalLoadHandler);
            };

            document.addEventListener('transmittalDataLoaded', transmittalLoadHandler);

            // Trigger transmittal data loaded event
            const transmittalLoadedEvent = new CustomEvent('transmittalDataLoaded');
            document.dispatchEvent(transmittalLoadedEvent);

            if (callback) callback();
        } else {
            console.log('Fetching fresh transmittal page content.');
            showLoadingScreen('Loading Transmittal...', 'Fetching the latest data for you.');

            // Add event listener for transmittal data loaded
            const transmittalLoadHandler = (event) => {
                document.removeEventListener('transmittalDataLoaded', transmittalLoadHandler);
            };

            document.addEventListener('transmittalDataLoaded', transmittalLoadHandler);

            google.script.run.withSuccessHandler(function(content) {
                transmittalPageCache = content;
                document.getElementById('content-page').innerHTML = content;
                updatePageIndicator('transmittal');
                transmittalElements(); // Initialize transmittal page elements
                lastTransmittalFetchedTime = new Date();

                // Trigger transmittal data loaded event
                const transmittalLoadedEvent = new CustomEvent('transmittalDataLoaded');
                document.dispatchEvent(transmittalLoadedEvent);

                if (callback) callback();
            }).loadPageContent('transmittal');
        }
    } else if (page === 'dashboard') {
        showLoadingScreen('Loading Dashboard...', 'Please wait while we fetch the content.');

        // Add event listener for dashboard data loaded
        const dashboardLoadHandler = (event) => {
            document.removeEventListener('dashboardDataLoaded', dashboardLoadHandler);
            showToast('success', 'Dashboard loaded successfully!');
        };

        // Add event listener before loading the page
        document.addEventListener('dashboardDataLoaded', dashboardLoadHandler);

        google.script.run.withSuccessHandler(function(content) {
            document.getElementById('content-page').innerHTML = content;
            updatePageIndicator(page);

            if (callback) callback();
        }).loadPageContent(page);
    } else {
        // Existing logic for other pages
        showLoadingScreen('Loading Page...', 'Please wait while we fetch the content.');
        google.script.run.withSuccessHandler(function(content) {
            document.getElementById('content-page').innerHTML = content;
            updatePageIndicator(page);
            if (callback) callback();
        }).loadPageContent(page);
    }
}

// Update page indicator
function updatePageIndicator(page) {
    const indicator = document.getElementById('page-indicator');
    if (indicator) {
        indicator.innerText = page === 'transmittal' ? 'Transmittal' :
            page === 'dashboard' ? 'Dashboard' :
            page === 'admin-dashboard' ? 'Admin Dashboard' :
            'Unknown Page';
    } else {
        console.warn('Page indicator element is missing from the DOM.');
    }
}
</script>
